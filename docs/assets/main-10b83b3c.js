(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function e(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=e(r);fetch(r.href,s)}})();var b={},h={};Object.defineProperty(h,"__esModule",{value:!0});h.permutations=h.polarToRectangular=h.makeBoundedLinear=S=h.makeLinear=h.sum=h.countMap=v=h.initializedArray=q=h.count=h.zip=h.FIGURE_SPACE=h.NON_BREAKING_SPACE=h.dateIsValid=h.MIN_DATE=h.MAX_DATE=h.makePromise=h.filterMap=k=h.pick=h.pickAny=h.csvStringToArray=h.parseTimeT=h.parseIntX=h.parseFloatX=h.getAttribute=h.followPath=h.parseXml=h.testXml=H=h.sleep=h.assertClass=void 0;function ot(n,t,e="Assertion Failed."){const o=r=>{throw new Error(`${e}  Expected type:  ${t.name}.  Found type:  ${r}.`)};if(n===null)o("null");else if(typeof n!="object")o(typeof n);else if(!(n instanceof t))o(n.constructor.name);else return n;throw new Error("wtf")}h.assertClass=ot;function rt(n){return new Promise(t=>setTimeout(t,n))}var H=h.sleep=rt;function X(n){const e=new DOMParser().parseFromString(n,"application/xml");for(const o of Array.from(e.querySelectorAll("parsererror")))if(o instanceof HTMLElement)return{error:o};return{parsed:e}}h.testXml=X;function st(n){if(n!==void 0)return X(n)?.parsed?.documentElement}h.parseXml=st;function j(n,...t){for(const e of t){if(n===void 0)return;if(typeof e=="number")n=n.children[e];else{const o=n.getElementsByTagName(e);if(o.length!=1)return;n=o[0]}}return n}h.followPath=j;function at(n,t,...e){if(t=j(t,...e),t!==void 0&&t.hasAttribute(n))return t.getAttribute(n)??void 0}h.getAttribute=at;function _(n){if(n==null)return;const t=parseFloat(n);if(isFinite(t))return t}h.parseFloatX=_;function U(n){const t=_(n);if(t!==void 0)return t>Number.MAX_SAFE_INTEGER||t<Number.MIN_SAFE_INTEGER||t!=Math.floor(t)?void 0:t}h.parseIntX=U;function it(n){if(typeof n=="string"&&(n=U(n)),n!=null&&!(n<=0))return new Date(n*1e3)}h.parseTimeT=it;const lt=n=>{const t=/(,|\r?\n|\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^,\r\n]*))/gi,e=[[]];let o;for(;o=t.exec(n);)o[1].length&&o[1]!==","&&e.push([]),e[e.length-1].push(o[2]!==void 0?o[2].replace(/""/g,'"'):o[3]);return e};h.csvStringToArray=lt;function ct(n){const t=n.values().next();if(!t.done)return t.value}h.pickAny=ct;function ut(n){return n[Math.random()*n.length|0]}var k=h.pick=ut;function dt(n,t){const e=[];return n.forEach((o,r)=>{const s=t(o,r);s!==void 0&&e.push(s)}),e}h.filterMap=dt;function ht(){let n,t;return{promise:new Promise((o,r)=>{n=o,t=r}),resolve:n,reject:t}}h.makePromise=ht;h.MAX_DATE=new Date(864e13);h.MIN_DATE=new Date(-864e13);function mt(n){return isFinite(n.getTime())}h.dateIsValid=mt;h.NON_BREAKING_SPACE=" ";h.FIGURE_SPACE=" ";function*ft(...n){const t=n.map(e=>e[Symbol.iterator]());for(;;){const e=t.map(o=>o.next());if(e.some(({done:o})=>o))break;yield e.map(({value:o})=>o)}}h.zip=ft;function*pt(n=0,t=1/0,e=1){for(let o=n;o<t;o+=e)yield o}var q=h.count=pt;function K(n,t){const e=[];for(let o=0;o<n;o++)e.push(t(o));return e}var v=h.initializedArray=K;h.countMap=K;function gt(n){return n.reduce((t,e)=>t+e,0)}h.sum=gt;function wt(n,t,e,o){const r=(o-t)/(e-n);return function(s){return(s-n)*r+t}}var S=h.makeLinear=wt;function bt(n,t,e,o){e<n&&([n,t,e,o]=[e,o,n,t]);const r=(o-t)/(e-n);return function(s){return s<=n?t:s>=e?o:(s-n)*r+t}}h.makeBoundedLinear=bt;function Et(n,t){return{x:Math.sin(t)*n,y:Math.cos(t)*n}}h.polarToRectangular=Et;function*W(n,t=[]){if(n.length==0)yield t;else for(let e=0;e<n.length;e++){const o=n[e],r=[...t,o],s=[...n.slice(0,e),...n.slice(e+1)];yield*W(s,r)}}h.permutations=W;Object.defineProperty(b,"__esModule",{value:!0});b.download=b.createElementFromHTML=b.getHashInfo=b.getAudioBalanceControl=b.getBlobFromCanvas=b.loadDateTimeLocal=E=b.getById=void 0;const Q=h;function yt(n,t){const e=document.getElementById(n);if(!e)throw new Error("Could not find element with id "+n+".  Expected type:  "+t.name);if(e instanceof t)return e;throw new Error("Element with id "+n+" has type "+e.constructor.name+".  Expected type:  "+t.name)}var E=b.getById=yt;function vt(n,t,e="milliseconds"){let o;switch(e){case"minutes":{o=t.getSeconds()*1e3+t.getMilliseconds();break}case"seconds":{o=t.getMilliseconds();break}case"milliseconds":{o=0;break}default:throw new Error("wtf")}n.valueAsNumber=+t-t.getTimezoneOffset()*6e4-o}b.loadDateTimeLocal=vt;function It(n){const{reject:t,resolve:e,promise:o}=(0,Q.makePromise)();return n.toBlob(r=>{r?e(r):t(new Error("blob is null!"))}),o}b.getBlobFromCanvas=It;function kt(n){const t=new AudioContext,e=t.createMediaElementSource(n),o=new StereoPannerNode(t,{pan:0});return e.connect(o).connect(t.destination),r=>{o.pan.value=r}}b.getAudioBalanceControl=kt;function Mt(){const n=new Map;return/^#?(.*)$/.exec(location.hash.replace("+","%20"))[1].split("&").forEach(o=>{const r=o.split("=",2);if(r.length==2){const s=decodeURIComponent(r[0]),a=decodeURIComponent(r[1]);n.set(s,a)}}),n}b.getHashInfo=Mt;function xt(n,t){var e=document.createElement("div");return e.innerHTML=n.trim(),(0,Q.assertClass)(e.firstChild,t,"createElementFromHTML:")}b.createElementFromHTML=xt;function St(n,t){var e=document.createElement("a");if(e.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),e.setAttribute("download",n),document.createEvent){var o=document.createEvent("MouseEvents");o.initEvent("click",!0,!0),e.dispatchEvent(o)}else e.click()}b.download=St;class Ct{#t=new Set;get contents(){return[...this.#t].map(t=>t.piece)}get size(){return this.#t.size}debugInitialCell;color;constructor(t){this.color=t.color,this.debugInitialCell=t,this.#t.add(t)}consume(t){const e=this.#t,o=t.#t;return o.forEach(r=>e.add(r)),t.#t=void 0,o}get valid(){return!!this.#t?.has(this.debugInitialCell)}}class F{constructor(t){this.piece=t,this.#t=new Ct(this)}#t;get color(){return this.piece.color}static createAll(t){return t.map(e=>e.map(o=>new F(o)))}tryCombine(t){if(this.#t!=t.#t&&this.color==t.color&&(this.#t.consume(t.#t).forEach(o=>o.#t=this.#t),!this.#t.valid))throw new Error("wtf")}static combineAll(t){t.forEach((e,o)=>{e.forEach((r,s)=>{if(o){const a=o-1,i=t[a][s];r.tryCombine(i)}if(s){const a=s-1,i=e[a];r.tryCombine(i)}})})}static findBigGroups(t){const e=new Map;t.forEach(r=>r.forEach(s=>{const a=s.#t,i=e.get(a)??0;e.set(a,i+1)}));const o=[];for(const[r,s]of e)s>=3&&o.push(r);return o}static findActionable(t){const e=this.createAll(t);return this.combineAll(e),this.findBigGroups(e)}}function B(n){return F.findActionable(n).map(t=>t.contents)}function P(n,t){const e=n%t;return e<0?e+Math.abs(t):e}function Tt(n,t){if((t|0)!=t)throw new Error(`invalid input: ${t}`);return t=P(t,n.length),t==0?n:[...n.slice(t),...n.slice(0,t)]}function $(n,t,e="Assertion Failed."){const o=r=>{throw new Error(`${e}  Expected type:  ${t.name}.  Found type:  ${r}.`)};if(n===null)o("null");else if(typeof n!="object")o(typeof n);else if(!(n instanceof t))o(n.constructor.name);else return n;throw new Error("wtf")}function Y(n,t){return{x:Math.cos(t)*n,y:Math.sin(t)*n}}function J(n){if(n.length<1)throw new Error("wtf");const t=Math.random()*n.length|0;return n.splice(t,1)[0]}const R=n=>P(Math.round(n),g.SIZE);function At(n,t,e){const o=n[t],r=Tt(o,e);return o==r?n:n.map(s=>s==o?r:s)}function Pt(n,t,e){const o=n.length;return e=P(e,o),e==0?n:n.map((r,s)=>{const a=[...r];return a[t]=n[(s+e)%o][t],a})}const M=["red","green","blue","yellow","orange","violet","whitesmoke"];class A{constructor(t,e,o=A.randomColor()){this.rowIndex=t,this.columnIndex=e,this.color=o}weight=1;bomb=!1;static randomColor(){return k(M)}}class g{constructor(t){this.animator=t,this.#t=this.createRandom(),this.animator.initializeBoard(this.#t.flat())}static SIZE=6;#t;getColumn(t){return this.#t.map(e=>e[t])}createRandom(){const t=v(g.SIZE,o=>v(g.SIZE,r=>new A(o,r)));return B(t).forEach(o=>{o.forEach(({rowIndex:r,columnIndex:s})=>{const a=new Set;[[0,1],[0,-1],[1,0],[-1,0]].forEach(([i,u])=>{const d=t[r+i];if(d){const l=d[s+u];l&&a.add(l.color)}}),t[r][s]=new A(r,s,k(M.filter(i=>!a.has(i))))})}),t}async updateLoop(t,e){for(let o=1;t.length>0;o++){const r=new Set,s=[];t.forEach(c=>{if(c.length>5)s.push(c);else if(c.length==5){const m=k(c);m.bomb=!0,r.add(m)}});const a=[];{let c=t.flat();const m=new Set(c);for(;;){const p=c.filter(f=>f.bomb&&!r.has(f));if(p.length==0)break;c.length=0;for(let f=-1;f<=1;f++)for(let w=-1;w<=1;w++)p.forEach(y=>{const I=this.#t[y.rowIndex+f]?.[y.columnIndex+w];I&&!m.has(I)&&(c.push(I),m.add(I))});a.push(c)}}console.log(a),e.addToScore(o,a.flat().length);const i=t.flatMap(c=>c.filter(m=>!r.has(m))),u=this.removePieces(i),d=this.#t.flat().filter(c=>!c.bomb),l=s.map(c=>{const m=[];return c.forEach(p=>{if(!p.bomb&&d.length>0){const f=J(d);m.push({source:p,destination:f})}}),m});await this.animator.updateBoard({remove:i,counter:o,flingBomb:l,destroyByBomb:a,add:u}),l.flat().forEach(({destination:c})=>c.bomb=!0),t=B(this.#t),e=this.animator.assignGroupDecorations(t),e.highlightGroups()}}setAllPieces(t){this.#t=t,t.forEach((e,o)=>{e.forEach((r,s)=>{r.columnIndex=s,r.rowIndex=o})})}startHorizontalMove(t){const e=v(g.SIZE,s=>{const a=At(this.#t,t,-s),i=B(a);return{actions:this.animator.assignGroupDecorations(i),groups:i,pieces:a}}),o=s=>{const a=this.#t[t];this.animator.drawPreview("horizontal",a,s),e[R(s)].actions.highlightGroups()};return{preview:o,release:async s=>{o(s);const a=R(s),u=e[a].groups.length==0?0:a,d=e[u];this.setAllPieces(d.pieces);const l=this.#t[t];await this.animator.rotateTo("horizontal",l),await this.updateLoop(d.groups,d.actions)}}}startVerticalMove(t){const e=v(g.SIZE,s=>{const a=Pt(this.#t,t,-s),i=B(a);return{actions:this.animator.assignGroupDecorations(i),groups:i,pieces:a}}),o=s=>{const a=this.getColumn(t);this.animator.drawPreview("vertical",a,s),e[R(s)].actions.highlightGroups()};return{preview:o,release:async s=>{o(s);const a=R(s),u=e[a].groups.length==0?0:a,d=e[u];this.setAllPieces(d.pieces);const l=this.getColumn(t);await this.animator.rotateTo("vertical",l),await this.updateLoop(d.groups,d.actions)}}}removePieces(t){const e=v(g.SIZE,()=>new Set);t.forEach(({rowIndex:s,columnIndex:a})=>{const i=e[a];if(i.has(s))throw new Error("wtf");i.add(s)});const o=v(g.SIZE,()=>new Array(g.SIZE)),r=[];return e.forEach((s,a)=>{const i=[];for(let u=0;u<g.SIZE;u++)s.has(u)||i.push(this.#t[u][a]);for(let u=0;i.length<g.SIZE;u++){const d=-1-u,l=new A(NaN,a);r.push({initialRow:d,piece:l}),i.unshift(l)}i.forEach((u,d)=>{o[d][a]=u,u.columnIndex=a,u.rowIndex=d})}),this.setAllPieces(o),r}}function Bt(n,t,e){if(!(t>=0&&t<=1))throw new Error("Expected 0 ≤ t ≤ 1");const o=Math.max(0,t-e),r=n(o),s=Math.max(0,t+e),a=n(s),i=a.x-r.x,u=a.y-r.y;return i==0&&u==0?NaN:Math.atan2(u,i)}function tt(n,t={}){const e=Math.ceil(t.numberOfSegments??10);if(e<1)throw new Error(`Invalid numberOfSegments: ${e}`);const o=.01/e,r=v(e+1,i=>{const u=i/e,d=n(u),l=Bt(n,u,o);return{t:u,point:d,direction:l}}),s=v(e,i=>[{from:r[i],to:r[i+1]}][0]);let a=`M ${s[0].from.point.x}, ${s[0].from.point.y}`;return s.forEach(i=>{const u=Lt({x0:i.from.point.x,y0:i.from.point.y,slope:Math.tan(i.from.direction)},{x0:i.to.point.x,y0:i.to.point.y,slope:Math.tan(i.to.direction)});u?a+=` Q ${u.x},${u.y}`:a+=" M",a+=` ${i.to.point.x},${i.to.point.y}`}),a}function Rt(n,t,e){const o=Dt(n,t,e);return tt(o,{numberOfSegments:e*9.001002})}function Dt(n,t,e){const s={x:n.x-t.x,y:n.y-t.y},a=Math.hypot(s.x,s.y),i=S(0,a,1,0),u=Math.atan2(s.y,s.x),d=S(0,u,1,u+e*2*Math.PI);return function(l){const c=i(l),m=d(l),p=Y(c,m);return{x:t.x+p.x,y:t.y+p.y}}}function Nt(n,t,e){const o=S(0,t,1,e);return r=>Y(n,o(r))}function $t(n,t){const e=S(0,n.x,1,t.x),o=S(0,n.y,1,t.y);return r=>({x:e(r),y:o(r)})}function Ft(n,t,...e){const o=i=>{const u={x:0,y:0};return e.forEach(d=>{const l=d(i);u.x+=l.x,u.y+=l.y}),u},r=o(0),s=o(1),a=$t({x:n.x-r.x,y:n.y-r.y},{x:t.x-s.x,y:t.y-s.y});return e.push(a),o}function Lt(n,t){if(isNaN(n.slope)||isNaN(t.slope)||n.slope==t.slope)return;const e=n.slope==1/0||n.slope==-1/0,o=t.slope==1/0||t.slope==-1/0;if(e||o)return;const r=e?n.x0:o?t.x0:(t.y0-t.slope*t.x0-n.y0+n.slope*n.x0)/(n.slope-t.slope),s=e?t.slope*(r-t.x0)+t.y0:n.slope*(r-n.x0)+n.y0;return{x:r,y:s}}const T=E("newScore",HTMLDivElement),O=E("chainBonus",HTMLDivElement),et=new Map([["orange",["cyan","brown","white","darkviolet","lightyellow","darkgreen","darkolivegreen","darkred"]],["yellow",["brown","darkviolet","lightcoral","lightsalmon","lightseagreen","darkblue","darkcyan","darkgoldenrod","darkgreen","darkkhaki","darkolivegreen","darkorange","darkred","darksalmon","darkseagreen"]],["violet",["cyan","brown","white","darkviolet","lightgreen","darkblue"]],["blue",["cyan","white","lightcoral","lightgreen","lightgray","lightsalmon","lightseagreen","lightseagreen","lightskyblue","lightslategray","darkorange","darkseagreen","darkturquoise"]],["red",["cyan","white","lightcoral","lightgreen","lightsalmon","darkkhaki","darkseagreen","chartreuse"]],["green",["cyan","white","lightcoral","lightcyan","lightgreen","lightyellow","darkred","darkseagreen","chartreuse"]],["whitesmoke",["green","red","blue","cadetblue","aqua","chartreuse","coral","darkblue","darkgoldenrod","darkgreen","darkmagenta","darkorange","fuchsia","tomato","peru"]]]),L=["୰","༕","࿈","࿊","᭧","℆","℥","⅊","⇰","⌬","⍩","⎃","⎗","⏕","ॐ","࿄","༟","༴","℣","⌰","⍷","⎙","ʻ","☆","𝛿","∞","•","⭑","†","‡","؟","༗","ၯ","◦","§","_","ɝ","Ԕ","⟳","⚐","🜚","愛","❝","ℵ","を","ᇸ","ڰ","ॾ","ན","ᛧ","ß","⧕","↯","➷","⅋","☙","„","⌥","⧷","⁎","╕","₰","…","⑈","۽","ₜ","ಠ","෴","ጃ","ᔱ","ᔰ","Ѧ","ᑥ","𝄢","ƈ","Ɣ","ƕ","Ɋ","ɕ","ɮ","ʆ","Ξ","Ж","Ѭ","Զ","ঔ","ਐ","ઝ","ଈ","ஜ","ధ","ൠ","ඊ","ጯ","ᡀ","‰","₻","↉","↜","↸","⋨","⌤","⎌","⍾","☏","✗","➘","〷","ご","ᇌ","㊤","﹆","🜇","🝤","⅏"];setInterval(()=>{document.title=`${k(L)} Classic Chuzzle`},1500);let x=1;function nt(n){return Math.abs(n)*2e3/g.SIZE*x}const G=E("board",SVGElement);function V(){G.querySelectorAll("text.crystal-decoration,text.crystal-decoration-background").forEach(n=>n.textContent="")}class C{static#t=E("piece",HTMLTemplateElement).content.querySelector("g");element;decorationElement;decorationBackgroundElement;bombElement;get bombVisible(){return this.bombElement.style.display==""}set bombVisible(t){this.bombElement.style.display=t?"":"none"}static#o=CSS.px(Math.E);static#r=CSS.px(Math.PI);static#s=new CSSTransformValue([new CSSTranslate(this.#o,this.#r)]);updateFinalPosition(t){this.#n=t.columnIndex,this.#e=t.rowIndex,C.#o.value=t.columnIndex,C.#r.value=t.rowIndex,this.element.attributeStyleMap.set("transform",C.#s)}async slideDirectlyTo(t,e){const o=this.#n,r=this.#e,s=t.columnIndex,a=t.rowIndex;(o!=s||r!=a)&&(await this.element.animate([{transform:`translate(${o}px, ${r}px)`},{transform:`translate(${s}px, ${a}px)`}],e).finished,this.updateFinalPosition(t))}async rotateTo(t,e){const o=e=="horizontal",r=(()=>{const u=o?t.columnIndex-this.#n:t.rowIndex-this.#e,d=P(u+g.SIZE/2,g.SIZE)-g.SIZE/2;return nt(Math.abs(d))})(),{position:s,offset:a}=o?z(this.#n,t.columnIndex):z(this.#e,t.rowIndex),i=s.map(u=>o?`translate(${u}px, ${t.rowIndex}px)`:`translate(${t.columnIndex}px, ${u}px)`);this.updateFinalPosition(t),await this.element.animate({transform:i,offset:a},r).finished}#e=NaN;get rowIndex(){return this.#e}#n=NaN;get columnIndex(){return this.#n}constructor(t){const e=$(C.#t.cloneNode(!0),SVGGElement);this.element=e,this.decorationElement=e.querySelector("text.crystal-decoration"),this.decorationBackgroundElement=e.querySelector("text.crystal-decoration-background"),this.bombElement=e.querySelector(".bomb"),e.style.fill=t.color,this.decorationBackgroundElement.style.stroke=t.color,this.bombColor=k(et.get(t.color)),this.bombVisible=!1,this.updateFinalPosition(t),G.appendChild(e)}async remove(t=0){let e,o;e=Math.random()*(g.SIZE/2-1),o=Math.random()*(g.SIZE/2-1);{const r=Math.random()*3;r>1&&(e-=g.SIZE/2),r<2&&(o-=g.SIZE/2)}{const r=s=>Math.random()>(s+1)/(g.SIZE+1);r(this.#e)&&(e=g.SIZE-e-1),r(this.#n)&&(o=g.SIZE-o-1)}this.element.parentElement.appendChild(this.element),await this.slideDirectlyTo({rowIndex:e,columnIndex:o},{duration:1e3*x,easing:"ease-in",delay:t,fill:"backwards"}),this.element.remove(),this.element="💀"}get bombColor(){return this.bombElement.style.fill}set bombColor(t){this.bombElement.style.fill=t}removeDecoration(){[this.decorationElement,this.decorationBackgroundElement].forEach(t=>{t.textContent="",t.getAnimations().forEach(e=>e.cancel())})}}const Z=n=>P(n+.5,g.SIZE)-.5,z=(n,t)=>{const e=[n],o=[0];if(Math.abs(n-t)>g.SIZE/2){const r=(s,a)=>{e.push(s,a);const i=Math.abs(n-s),u=Math.abs(a-t),d=i+u,l=i/d;o.push(l,l)};t>n?r(-.5,g.SIZE-.5):r(g.SIZE-.5,-.5)}return e.push(t),o.push(1),{position:e,offset:o}},N=E("piece",HTMLTemplateElement).content.querySelector(".bomb"),Gt=E("main",SVGSVGElement);class Ot{initializeBoard(t){G.innerHTML="",this.#t.clear(),t.forEach(e=>this.#t.set(e,new C(e)))}async updateBoard(t){this.#t.forEach((l,c)=>{l.bombVisible=c.bomb}),x=Math.pow(.75,t.counter-1)*.9+.1,t.flingBomb.length>1&&(x=Math.max(.5,Math.min(1,x*2)));const e=2e3*x,o=t.flingBomb.map(l=>l.map(({source:c,destination:m})=>{const p=this.#t.get(c);if(p===void 0)throw new Error("wtf");return{logicalSource:c,logicalDestination:m,guiSource:p}})),r=Promise.all(t.remove.map(l=>{const c=this.#t.get(l).remove(e);return this.#t.delete(l),c}));setTimeout(()=>this.#t.forEach(l=>l.removeDecoration()),e);const s=1e3*x;t.add.forEach(({initialRow:l,piece:c})=>{const m=new C(c);this.#t.set(c,m),m.updateFinalPosition({columnIndex:c.columnIndex,rowIndex:l})});let a=0;const i=[];this.#t.forEach((l,c)=>{const m=l.columnIndex,p=l.rowIndex,f=c.columnIndex,w=c.rowIndex,y=Math.hypot(w-p,f-m),I=nt(y),D={duration:I,delay:e+s,fill:"backwards"};i.push(()=>l.slideDirectlyTo(c,D)),a=Math.max(a,I)});const u=Promise.all(o.flatMap(l=>{const c=e+s+a;return l.map((m,p)=>{const f=Math.min(e,c/2)/(l.length+1)*(p+1),w=c-f;return this.flingBomb(m,f,w)})})),d=Promise.all(i.map(l=>l()));await Promise.all([r,d,u])}async flingBomb(t,e,o){const{logicalSource:r,logicalDestination:s,guiSource:a}=t,i=this.#t.get(s),u=s.color,d=i.bombColor;a.bombColor=d,a.bombVisible=!0;const l=(()=>{const m=$(N.cloneNode(!0),SVGPathElement),p=$(N.cloneNode(!0),SVGPathElement);p.style.strokeWidth="75",m.style.fill=d,p.style.stroke=u;const f=document.createElementNS("http://www.w3.org/2000/svg","g");return f.appendChild(p),f.appendChild(m),f.style.offsetRotate="0deg",f})(),c=(()=>{const m={x:r.columnIndex,y:r.rowIndex},p={x:s.columnIndex,y:s.rowIndex};if(Math.random()<.3333333)return Rt(m,p,.5+Math.random()*2+Math.random()*2);{const f=Math.random()*2*Math.PI,w=(Math.random()*2|0)*2-1,y=f+w*(.5+Math.random()*2)*2*Math.PI,I=.5+Math.random()*2,D=Ft(m,p,Nt(I,f,y));return tt(D,{numberOfSegments:20})}})();await H(e),a.bombVisible=!1,Gt.appendChild(l),l.style.offsetPath=`path('${c}')`,await l.animate({offsetDistance:["0%","100%"]},{duration:o,iterations:1,easing:"ease-in",fill:"both"}).finished,l.remove(),i.bombVisible=!0}#t=new Map;drawPreview(t,e,o){e.forEach(r=>{const s=this.#t.get(r);let{rowIndex:a,columnIndex:i}=r;t=="vertical"?a=Z(a+o):i=Z(i+o),s.updateFinalPosition({rowIndex:a,columnIndex:i})})}async rotateTo(t,e){const o=e.map(r=>this.#t.get(r).rotateTo(r,t));await Promise.all(o)}assignGroupDecorations(t){if(t.length==0)return{addToScore(){},highlightGroups(){V()}};{const e=[...L],o=t.map(r=>{const s=r[0].color,a=k(et.get(s)),i=J(e);return{guiPieces:r.map(d=>{const l=this.#t.get(d);if(l==null)throw new Error("wtf");return l}),decorationColor:a,decorationText:i,backgroundColor:s}});return{addToScore(r,s){if(o.forEach(({guiPieces:a})=>{const d=[{opacity:Math.random()*.2+.05},{opacity:1}],l={direction:k(["alternate","alternate-reverse","normal","reverse"]),duration:(550+Math.random()*150)*x,easing:k(["linear","ease-in","ease-out","ease-in-out"]),iterationStart:Math.random(),iterations:1/0};a.forEach(c=>{c.decorationElement.animate(d,l),c.decorationBackgroundElement.animate(d,l)})}),r<2?O.innerHTML="":O.innerText=`Chain Bonus: ⨉ ${r}`,T.innerHTML="",o.forEach(({guiPieces:a,decorationColor:i,decorationText:u,backgroundColor:d},l)=>{l>0&&T.append(" + ");const c=document.createElement("span");c.innerText=`${u} ${a.length}`,c.style.color=i,c.style.borderColor=c.style.backgroundColor=d,c.classList.add("individualScore"),T.appendChild(c)}),s>0){o.length>0&&T.append(" + ");const a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttribute("viewBox","0.25 0.25 0.5 0.5");const i=N.cloneNode(!0);a.appendChild(i),a.style.width="1em",a.style.height="1em",a.style.fill="white";const u=document.createElement("span");u.innerHTML=`&nbsp;${s}`,u.style.color="white",u.style.borderColor=u.style.backgroundColor="black",u.classList.add("individualScore"),u.prepend(a),T.appendChild(u)}},highlightGroups(){V(),o.forEach(({guiPieces:r,decorationColor:s,decorationText:a})=>{r.forEach(i=>{const u=i.decorationElement;u.textContent=a,u.style.fill=s,i.decorationBackgroundElement.textContent=a})})}}}}}const Vt=new Ot,Zt=E("decorationTester",HTMLDivElement);L.forEach(n=>{const t=document.createElement("div");t.innerText=`${n} u+${n.codePointAt(0).toString(16)}`,Zt.appendChild(t)});const zt=""+new URL("cursor-2110db60.svg",import.meta.url).href;function Ht(n){const t=E("main",SVGSVGElement);function e(r){const s=t.getBoundingClientRect(),a=S(s.top,0,s.bottom,g.SIZE),i=S(s.left,0,s.right,g.SIZE);return{row:a(r.clientY),column:i(r.clientX)}}let o={state:"none"};t.addEventListener("pointerdown",r=>{if(o.state=="none"){r.stopPropagation(),t.setPointerCapture(r.pointerId);const s=e(r);t.style.cursor="move",o={state:"started",startRow:s.row,startColumn:s.column}}}),t.addEventListener("pointermove",r=>{if(o.state=="none"||o.state=="animation")return;r.stopPropagation();const s=e(r);if(o.state=="started"){const a=Math.abs(s.row-o.startRow),i=Math.abs(s.column-o.startColumn);if(Math.max(a,i)<.05)return;if(a>i){const u="vertical",d=Math.floor(o.startColumn),l=o.startRow,c=p=>{const{row:f}=e(p);return f-l},m=n.startVerticalMove(d);o={state:u,fixedIndex:d,startIndex:l,relevantMouseMove:c,actions:m},t.style.cursor="ns-resize"}else if(i>a){const u="horizontal",d=Math.floor(o.startRow),l=o.startColumn,c=p=>{const{column:f}=e(p);return f-l},m=n.startHorizontalMove(d);o={state:u,fixedIndex:d,startIndex:l,relevantMouseMove:c,actions:m},t.style.cursor="ew-resize"}else return}o.actions.preview(o.relevantMouseMove(r))}),t.addEventListener("lostpointercapture",async r=>{switch(o.state){case"started":break;case"horizontal":case"vertical":{t.style.cursor=`url("${zt}"),none`;const s=o;o={state:"animation"},await s.actions.release(s.relevantMouseMove(r));break}default:throw new Error("wtf")}o={state:"none"},t.style.cursor="grab"})}{class n{constructor(){throw new Error("wtf")}static#t=0;static get next(){return`Unique_${this.#t++}`}}const t=(d,l,c)=>{const m=l=="checked",p=n.next,f=document.createElement("div");E("debugButtons",HTMLDivElement).appendChild(f);const w=document.createElement("input");w.type="checkbox",w.checked=m,w.id=p,f.appendChild(w);const y=document.createElement("label");y.innerText=d,y.htmlFor=p,f.appendChild(y),c(m),w.addEventListener("change",()=>c(w.checked))},e=[],o=E("background",SVGGElement),[r,s]=v(2,()=>{const d=document.createElementNS("http://www.w3.org/2000/svg","g");o.appendChild(d),d.style.transformOrigin="3px 3px";const l=g.SIZE*(Math.SQRT2-1)/2,c=0-l,m=g.SIZE+l;for(const p of q(c,m)){const f=document.createElementNS("http://www.w3.org/2000/svg","line");f.x1.baseVal.value=c,f.y1.baseVal.value=p,f.x2.baseVal.value=m,f.y2.baseVal.value=p,f.style.strokeWidth="0.1",f.style.strokeLinecap="round",d.appendChild(f)}return d});e.push(r.animate([{transform:"rotate(720deg)"},{transform:"rotate(0deg)"}],{duration:67973,easing:"ease",iterations:1/0})),e.push(s.animate([{transform:"rotate(0deg)"},{transform:"rotate(360deg)"}],{duration:19701,easing:"cubic-bezier(0.42, 0, 0.32, 1.83)",iterations:1/0}));const a=[r.animate(M.flatMap((d,l,c)=>[{stroke:"black",offset:l/c.length},{stroke:d,offset:(l+.25)/c.length},{stroke:d,offset:(l+.75)/c.length},{stroke:"black",offset:(l+1)/c.length}]),{duration:3210*M.length,iterations:1/0,easing:`steps(${M.length*2}, jump-start)`}),s.animate(M.flatMap((d,l,c)=>[{stroke:"white",offset:l/c.length},{stroke:d,offset:(l+.25)/c.length},{stroke:d,offset:(l+.75)/c.length},{stroke:"white",offset:(l+1)/c.length}]),{duration:4321*M.length,iterations:1/0,easing:`steps(${M.length*2}, jump-start)`})],i=E("main",SVGSVGElement).animate({backgroundColor:["#202020","#e0e0e0","#202020"]},{duration:97531,direction:"alternate",iterations:1/0});[[e,"line rotations","checked"],[a,"line colors","checked"],[[i],"back wall colors","checked"]].forEach(([d,l,c])=>{t(`Animate ${l}`,c,m=>{const p=m?"play":"pause";d.forEach(f=>f[p]())})});const u=E("curtain",SVGRectElement);[[o,"background","checked"],[u,"curtain","unchecked"]].forEach(([d,l,c])=>{t(`Show ${l}`,c,m=>{d.style.display=m?"":"none"})})}Ht(new g(Vt));
