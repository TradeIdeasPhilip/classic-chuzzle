(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const d of l.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&o(d)}).observe(document,{childList:!0,subtree:!0});function n(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(i){if(i.ep)return;i.ep=!0;const l=n(i);fetch(i.href,l)}})();var C={},E={};(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.countMap=e.Random=e.phi=e.radiansPerDegree=e.degreesPerRadian=e.FULL_CIRCLE=e.FIGURE_SPACE=e.NON_BREAKING_SPACE=e.MIN_DATE=e.MAX_DATE=e.csvStringToArray=void 0,e.assertClass=t,e.sleep=n,e.testXml=o,e.parseXml=i,e.followPath=l,e.getAttribute=d,e.parseFloatX=s,e.parseIntX=c,e.parseTimeT=h,e.pickAny=f,e.pick=w,e.take=p,e.filterMap=b,e.makePromise=M,e.dateIsValid=A,e.angleBetween=T,e.positiveModulo=I,e.rotateArray=K,e.rectUnion=z,e.rectAddPoint=Q,e.dateToFileName=Y,e.lerp=tt,e.assertFinite=et,e.shuffleArray=nt,e.zip=ot,e.count=rt,e.initializedArray=O,e.sum=it,e.makeLinear=st,e.makeBoundedLinear=at,e.polarToRectangular=lt,e.permutations=G;function t(r,u,m="Assertion Failed."){const g=v=>{throw new Error(`${m}  Expected type:  ${u.name}.  Found type:  ${v}.`)};if(r===null)g("null");else if(typeof r!="object")g(typeof r);else if(!(r instanceof u))g(r.constructor.name);else return r;throw new Error("wtf")}function n(r){return new Promise(u=>{setTimeout(u,r)})}function o(r){const m=new DOMParser().parseFromString(r,"application/xml");for(const g of Array.from(m.querySelectorAll("parsererror")))if(g instanceof HTMLElement)return{error:g};return{parsed:m}}function i(r){if(r!==void 0)return o(r)?.parsed?.documentElement}function l(r,...u){for(const m of u){if(r===void 0)return;if(typeof m=="number")r=r.children[m];else{const g=r.getElementsByTagName(m);if(g.length!=1)return;r=g[0]}}return r}function d(r,u,...m){if(u=l(u,...m),u!==void 0&&u.hasAttribute(r))return u.getAttribute(r)??void 0}function s(r){if(r==null)return;const u=+r;if(isFinite(u))return u}function c(r){const u=s(r);if(u!==void 0)return u>Number.MAX_SAFE_INTEGER||u<Number.MIN_SAFE_INTEGER||u!=Math.floor(u)?void 0:u}function h(r){if(typeof r=="string"&&(r=c(r)),r!=null&&!(r<=0))return new Date(r*1e3)}const a=r=>{const u=/(,|\r?\n|\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^,\r\n]*))/gi,m=[[]];let g;for(;g=u.exec(r);)g[1].length&&g[1]!==","&&m.push([]),m[m.length-1].push(g[2]!==void 0?g[2].replace(/""/g,'"'):g[3]);return m};e.csvStringToArray=a;function f(r){const u=r.values().next();if(!u.done)return u.value}function w(r){if(r.length==0)throw new Error("wtf");return r[Math.random()*r.length|0]}function p(r){if(r.length<1)throw new Error("wtf");const u=Math.random()*r.length|0;return r.splice(u,1)[0]}function b(r,u){const m=[];return r.forEach((g,v)=>{const S=u(g,v);S!==void 0&&m.push(S)}),m}function M(){let r,u;return{promise:new Promise((g,v)=>{r=g,u=v}),resolve:r,reject:u}}e.MAX_DATE=new Date(864e13),e.MIN_DATE=new Date(-864e13);function A(r){return isFinite(r.getTime())}e.NON_BREAKING_SPACE=" ",e.FIGURE_SPACE=" ",e.FULL_CIRCLE=2*Math.PI,e.degreesPerRadian=360/e.FULL_CIRCLE,e.radiansPerDegree=e.FULL_CIRCLE/360,e.phi=(1+Math.sqrt(5))/2;function T(r,u){const m=I(r,e.FULL_CIRCLE);let v=I(u,e.FULL_CIRCLE)-m;const S=e.FULL_CIRCLE/2;if(v>S?v-=e.FULL_CIRCLE:v<-S&&(v+=e.FULL_CIRCLE),Math.abs(v)>S)throw new Error("wtf");return v}function I(r,u){const m=r%u;return m<0?m+Math.abs(u):m}function K(r,u){if((u|0)!=u)throw new Error(`invalid input: ${u}`);return u=I(u,r.length),u==0?r:[...r.slice(u),...r.slice(0,u)]}class J{static sfc32(u,m,g,v){return function(){u|=0,m|=0,g|=0,v|=0;let S=(u+m|0)+v|0;return v=v+1|0,u=m^m>>>9,m=g+(g<<3)|0,g=g<<21|g>>>11,g=g+S|0,(S>>>0)/4294967296}}static#t=42;static create(u=this.newSeed()){console.info(u);const m=JSON.parse(u);if(!(m instanceof Array))throw new Error("invalid seed");if(m.length!=4)throw new Error("invalid seed");const[g,v,S,F]=m;if(!(typeof g=="number"&&typeof v=="number"&&typeof S=="number"&&typeof F=="number"))throw new Error("invalid seed");return this.sfc32(g,v,S,F)}static newSeed(){const u=[];return u.push(Date.now()),u.push(this.#t++),u.push(Math.random()*2**31|0),u.push(Math.random()*2**31|0),JSON.stringify(u)}}e.Random=J;function z(r,u){const m=Math.min(r.x,u.x),g=Math.min(r.y,u.y),v=Math.max(r.x+r.width,u.x+u.width),S=Math.max(r.y+r.height,u.y+u.height),F=v-m,ct=S-g;return{x:m,y:g,width:F,height:ct}}function Q(r,u,m){return z(r,{x:u,y:m,width:0,height:0})}function Y(r){return isNaN(r.getTime())?"0000⸱00⸱00 00⦂00⦂00":`${r.getFullYear().toString().padStart(4,"0")}⸱${(r.getMonth()+1).toString().padStart(2,"0")}⸱${r.getDate().toString().padStart(2,"0")} ${r.getHours().toString().padStart(2,"0")}⦂${r.getMinutes().toString().padStart(2,"0")}⦂${r.getSeconds().toString().padStart(2,"0")}`}function tt(r,u,m){return r+(u-r)*m}function et(...r){r.forEach(u=>{if(!isFinite(u))throw new Error("wtf")})}function nt(r){for(let u=r.length-1;u>0;u--){const m=Math.floor(Math.random()*(u+1));[r[u],r[m]]=[r[m],r[u]]}return r}function*ot(...r){const u=r.map(m=>m[Symbol.iterator]());for(;;){const m=u.map(g=>g.next());if(m.some(({done:g})=>g))break;yield m.map(({value:g})=>g)}}function*rt(r=0,u=1/0,m=1){for(let g=r;g<u;g+=m)yield g}function O(r,u){const m=[];for(let g=0;g<r;g++)m.push(u(g));return m}e.countMap=O;function it(r){return r.reduce((u,m)=>u+m,0)}function st(r,u,m,g){const v=(g-u)/(m-r);return function(S){return(S-r)*v+u}}function at(r,u,m,g){m<r&&([r,u,m,g]=[m,g,r,u]);const v=(g-u)/(m-r);return function(S){return S<=r?u:S>=m?g:(S-r)*v+u}}function lt(r,u){return{x:Math.cos(u)*r,y:Math.sin(u)*r}}function*G(r,u=[]){if(r.length==0)yield u;else for(let m=0;m<r.length;m++){const g=r[m],v=[...u,g],S=[...r.slice(0,m),...r.slice(m+1)];yield*G(S,v)}}})(E);Object.defineProperty(C,"__esModule",{value:!0});C.AnimationLoop=void 0;var k=C.getById=ut;C.loadDateTimeLocal=dt;C.getBlobFromCanvas=ht;C.getAudioBalanceControl=mt;C.getHashInfo=ft;C.createElementFromHTML=pt;C.download=gt;const _=E;function ut(e,t){const n=document.getElementById(e);if(!n)throw new Error("Could not find element with id "+e+".  Expected type:  "+t.name);if(n instanceof t)return n;throw new Error("Element with id "+e+" has type "+n.constructor.name+".  Expected type:  "+t.name)}function dt(e,t,n="milliseconds"){let o;switch(n){case"minutes":{o=t.getSeconds()*1e3+t.getMilliseconds();break}case"seconds":{o=t.getMilliseconds();break}case"milliseconds":{o=0;break}default:throw new Error("wtf")}e.valueAsNumber=+t-t.getTimezoneOffset()*6e4-o}function ht(e){const{reject:t,resolve:n,promise:o}=(0,_.makePromise)();return e.toBlob(i=>{i?n(i):t(new Error("blob is null!"))}),o}function mt(e){const t=new AudioContext,n=t.createMediaElementSource(e),o=new StereoPannerNode(t,{pan:0});return n.connect(o).connect(t.destination),i=>{o.pan.value=i}}function ft(){const e=new Map;return/^#?(.*)$/.exec(location.hash.replace("+","%20"))[1].split("&").forEach(o=>{const i=o.split("=",2);if(i.length==2){const l=decodeURIComponent(i[0]),d=decodeURIComponent(i[1]);e.set(l,d)}}),e}function pt(e,t){var n=document.createElement("div");return n.innerHTML=e.trim(),(0,_.assertClass)(n.firstChild,t,"createElementFromHTML:")}function gt(e,t){var n=document.createElement("a");if(n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),n.setAttribute("download",e),document.createEvent){var o=document.createEvent("MouseEvents");o.initEvent("click",!0,!0),n.dispatchEvent(o)}else n.click()}class wt{onWake;constructor(t){this.onWake=t,this.callback=this.callback.bind(this),requestAnimationFrame(this.callback)}#t=!1;cancel(){this.#t=!0}callback(t){this.#t||(requestAnimationFrame(this.callback),this.onWake(t))}}C.AnimationLoop=wt;function D(e){class t{#t=new Set;get contents(){return[...this.#t].map(s=>s.piece)}get size(){return this.#t.size}debugInitialCell;color;constructor(s){this.color=s.color,this.debugInitialCell=s,this.#t.add(s)}consume(s){const c=this.#t,h=s.#t;return h.forEach(a=>c.add(a)),s.#t=void 0,h}get valid(){return!!this.#t?.has(this.debugInitialCell)}}class n{constructor(s){this.piece=s,this.#t=new t(this)}#t;get color(){return this.piece.color}static createAll(s){return s.map(c=>c.map(h=>new n(h)))}tryCombine(s){if(this.#t!=s.#t&&this.color==s.color&&(this.#t.consume(s.#t).forEach(h=>h.#t=this.#t),!this.#t.valid))throw new Error("wtf")}static combineAll(s){s.forEach((c,h)=>{c.forEach((a,f)=>{if(h){const w=h-1,p=s[w][f];a.tryCombine(p)}if(f){const w=f-1,p=c[w];a.tryCombine(p)}})})}static findBigGroups(s){const c=new Map;s.forEach(a=>a.forEach(f=>{const w=f.#t,p=c.get(w)??0;c.set(w,p+1)}));const h=[];for(const[a,f]of c)f>=3&&h.push(a);return h}static findActionable(s){const c=this.createAll(s);return this.combineAll(c),this.findBigGroups(c)}}function o(d,s){const c=new Map;d.forEach((w,p)=>w.forEach((b,M)=>{c.set(b,{rowIndex:p,columnIndex:M})}));const h=[];let a=s.flat();const f=new Set(a);for(;;){const w=a.filter(p=>p.bomb);if(w.length==0)break;a=[];for(let p=-1;p<=1;p++)for(let b=-1;b<=1;b++)w.forEach(M=>{const{rowIndex:A,columnIndex:T}=c.get(M),I=d[A+p]?.[T+b];I&&!f.has(I)&&(a.push(I),f.add(I))});h.push(a)}return h}const i=n.findActionable(e).map(d=>d.contents),l=o(e,i);return{groups:i,explosions:l}}const N=e=>E.positiveModulo(Math.round(e),y.SIZE);function Et(e,t,n){const o=e[t],i=E.rotateArray(o,n);return o==i?e:e.map(l=>l==o?i:l)}function yt(e,t,n){const o=e.length;return n=E.positiveModulo(n,o),n==0?e:e.map((i,l)=>{const d=[...i];return d[t]=e[(l+n)%o][t],d})}const B=["red","green","blue","yellow","orange","violet","whitesmoke"];class R{constructor(t,n,o=R.randomColor()){this.rowIndex=t,this.columnIndex=n,this.color=o}weight=1;bomb=!1;static randomColor(){return E.pick(B)}}class y{constructor(t){this.animator=t,this.#t=y.#e(),this.animator.initializeBoard(this.#t.flat())}static SIZE=6;#t;getColumn(t){return this.#t.map(n=>n[t])}static#e(){const t=E.initializedArray(y.SIZE,o=>E.initializedArray(y.SIZE,i=>new R(o,i))),{groups:n}=D(t);return n.forEach(o=>{o.forEach(({rowIndex:i,columnIndex:l})=>{const d=new Set;[[0,1],[0,-1],[1,0],[-1,0]].forEach(([c,h])=>{const a=t[i+c];if(a){const f=a[l+h];f&&d.add(f.color)}});const s=new R(i,l,E.pick(B.filter(c=>!d.has(c))));t[i][l]=s})}),t}async updateLoop(t,n){for(let o=1;t.groups.length>0;o++){const i=new Set,l=[];t.groups.forEach(a=>{if(a.length>5)l.push(a);else if(a.length==5){const f=E.pick(a);f.bomb=!0,i.add(f)}}),n.addToScore(o);const d=t.groups.flatMap(a=>a.filter(f=>!i.has(f)));t.explosions.forEach(a=>a.forEach(f=>d.push(f)));const s=this.removePieces(d),c=this.#t.flat().filter(a=>!a.bomb),h=l.map(a=>{const f=[];return a.forEach(w=>{if(!w.bomb&&c.length>0){const p=E.take(c);f.push({source:w,destination:p})}}),f});await this.animator.updateBoard({remove:d,counter:o,flingBomb:h,destroyByBomb:t.explosions,add:s}),h.flat().forEach(({destination:a})=>a.bomb=!0),t=D(this.#t),n=this.animator.assignGroupDecorations(t),n.highlightGroups()}}setAllPieces(t){this.#t=t,t.forEach((n,o)=>{n.forEach((i,l)=>{i.columnIndex=l,i.rowIndex=o})})}startHorizontalMove(t){const n=E.initializedArray(y.SIZE,l=>{const d=Et(this.#t,t,-l),s=D(d);return{actions:this.animator.assignGroupDecorations(s),actionable:s,pieces:d}}),o=l=>{const d=this.#t[t];this.animator.drawPreview("horizontal",d,l),n[N(l)].actions.highlightGroups()};return{preview:o,release:async l=>{o(l);const d=N(l),c=n[d].actionable.groups.length==0?0:d,h=n[c];this.setAllPieces(h.pieces);const a=this.#t[t];await this.animator.rotateTo("horizontal",a),await this.updateLoop(h.actionable,h.actions)}}}startVerticalMove(t){const n=E.initializedArray(y.SIZE,l=>{const d=yt(this.#t,t,-l),s=D(d);return{actions:this.animator.assignGroupDecorations(s),actionable:s,pieces:d}}),o=l=>{const d=this.getColumn(t);this.animator.drawPreview("vertical",d,l),n[N(l)].actions.highlightGroups()};return{preview:o,release:async l=>{o(l);const d=N(l),c=n[d].actionable.groups.length==0?0:d,h=n[c];this.setAllPieces(h.pieces);const a=this.getColumn(t);await this.animator.rotateTo("vertical",a),await this.updateLoop(h.actionable,h.actions)}}}removePieces(t){const n=E.initializedArray(y.SIZE,()=>new Set);t.forEach(({rowIndex:l,columnIndex:d})=>{const s=n[d];if(s.has(l))throw new Error("wtf");s.add(l)});const o=E.initializedArray(y.SIZE,()=>new Array(y.SIZE)),i=[];return n.forEach((l,d)=>{const s=[];for(let c=0;c<y.SIZE;c++)l.has(c)||s.push(this.#t[c][d]);for(let c=0;s.length<y.SIZE;c++){const h=-1-c,a=new R(NaN,d);i.push({initialRow:h,piece:a}),s.unshift(a)}s.forEach((c,h)=>{o[h][d]=c,c.columnIndex=d,c.rowIndex=h})}),this.setAllPieces(o),i}}function bt(e,t,n){if(!(t>=0&&t<=1))throw new Error("Expected 0 ≤ t ≤ 1");const o=Math.max(0,t-n),i=e(o),l=Math.max(0,t+n),d=e(l),s=d.x-i.x,c=d.y-i.y;return s==0&&c==0?NaN:Math.atan2(c,s)}function j(e,t={}){const n=Math.ceil(t.numberOfSegments??10);if(n<1)throw new Error(`Invalid numberOfSegments: ${n}`);const o=.01/n,i=E.initializedArray(n+1,s=>{const c=s/n,h=e(c),a=bt(e,c,o);return{t:c,point:h,direction:a}}),l=E.initializedArray(n,s=>[{from:i[s],to:i[s+1]}][0]);let d=`M ${l[0].from.point.x}, ${l[0].from.point.y}`;return l.forEach(s=>{const c=Ct({x0:s.from.point.x,y0:s.from.point.y,slope:Math.tan(s.from.direction)},{x0:s.to.point.x,y0:s.to.point.y,slope:Math.tan(s.to.direction)});c?d+=` Q ${c.x},${c.y}`:d+=" M",d+=` ${s.to.point.x},${s.to.point.y}`}),d}function vt(e,t,n){const o=Mt(e,t,n);return j(o,{numberOfSegments:n*9.001002})}function Mt(e,t,n){const l={x:e.x-t.x,y:e.y-t.y},d=Math.hypot(l.x,l.y),s=E.makeLinear(0,d,1,0),c=Math.atan2(l.y,l.x),h=E.makeLinear(0,c,1,c+n*2*Math.PI);return function(a){const f=s(a),w=h(a),p=E.polarToRectangular(f,w);return{x:t.x+p.x,y:t.y+p.y}}}function St(e,t,n){const o=E.makeLinear(0,t,1,n);return i=>E.polarToRectangular(e,o(i))}function It(e,t){const n=E.makeLinear(0,e.x,1,t.x),o=E.makeLinear(0,e.y,1,t.y);return i=>({x:n(i),y:o(i)})}function kt(e,t,...n){const o=s=>{const c={x:0,y:0};return n.forEach(h=>{const a=h(s);c.x+=a.x,c.y+=a.y}),c},i=o(0),l=o(1),d=It({x:e.x-i.x,y:e.y-i.y},{x:t.x-l.x,y:t.y-l.y});return n.push(d),o}function Ct(e,t){if(isNaN(e.slope)||isNaN(t.slope)||e.slope==t.slope)return;const n=e.slope==1/0||e.slope==-1/0,o=t.slope==1/0||t.slope==-1/0;if(n||o)return;const i=n?e.x0:o?t.x0:(t.y0-t.slope*t.x0-e.y0+e.slope*e.x0)/(e.slope-t.slope),l=n?t.slope*(i-t.x0)+t.y0:e.slope*(i-e.x0)+e.y0;return{x:i,y:l}}const P=k("newScore",HTMLDivElement),Z=k("chainBonus",HTMLDivElement),X=new Map([["orange",["cyan","brown","white","darkviolet","lightyellow","darkgreen","darkolivegreen","darkred"]],["yellow",["brown","darkviolet","lightcoral","lightsalmon","lightseagreen","darkblue","darkcyan","darkgoldenrod","darkgreen","darkkhaki","darkolivegreen","darkorange","darkred","darksalmon","darkseagreen"]],["violet",["cyan","brown","white","darkviolet","lightgreen","darkblue"]],["blue",["cyan","white","lightcoral","lightgreen","lightgray","lightsalmon","lightseagreen","lightseagreen","lightskyblue","lightslategray","darkorange","darkseagreen","darkturquoise"]],["red",["cyan","white","lightcoral","lightgreen","lightsalmon","darkkhaki","darkseagreen","chartreuse"]],["green",["cyan","white","lightcoral","lightcyan","lightgreen","lightyellow","darkred","darkseagreen","chartreuse"]],["whitesmoke",["green","red","blue","cadetblue","aqua","chartreuse","coral","darkblue","darkgoldenrod","darkgreen","darkmagenta","darkorange","fuchsia","tomato","peru"]]]),V=["୰","༕","࿈","࿊","᭧","℆","℥","⅊","⇰","⌬","⍩","⎃","⎗","⏕","ॐ","࿄","༟","༴","℣","⌰","⍷","⎙","ʻ","☆","𝛿","∞","•","⭑","†","‡","؟","༗","ၯ","◦","§","_","ɝ","Ԕ","⟳","⚐","🜚","愛","❝","ℵ","を","ᇸ","ڰ","ॾ","ན","ᛧ","ß","⧕","↯","➷","⅋","☙","„","⌥","⧷","⁎","╕","₰","…","⑈","۽","ₜ","ಠ","෴","ጃ","ᔱ","ᔰ","Ѧ","ᑥ","𝄢","ƈ","Ɣ","ƕ","Ɋ","ɕ","ɮ","ʆ","Ξ","Ж","Ѭ","Զ","ঔ","ਐ","ઝ","ଈ","ஜ","ధ","ൠ","ඊ","ጯ","ᡀ","‰","₻","↉","↜","↸","⋨","⌤","⎌","⍾","☏","✗","➘","〷","ご","ᇌ","㊤","﹆","🜇","🝤","⅏","៚","๛"];setInterval(()=>{document.title=`${E.pick(V)} Classic Chuzzle`},1500);let x=1;function q(e){return Math.abs(e)*2e3/y.SIZE*x}const W=k("board",SVGElement);class L{static#t=k("piece",HTMLTemplateElement).content.querySelector("g");element;decorationElement;decorationBackgroundElement;#e;#r;get bombVisible(){return this.#e.style.display==""}set bombVisible(t){this.#e.style.display=t?"":"none"}get explosionVisible(){return this.#r.style.display==""}set explosionVisible(t){this.#r.style.display=t?"":"none"}static#i=CSS.px(Math.E);static#s=CSS.px(Math.PI);static#a=new CSSTransformValue([new CSSTranslate(this.#i,this.#s)]);updateFinalPosition(t){this.#o=t.columnIndex,this.#n=t.rowIndex,L.#i.value=t.columnIndex,L.#s.value=t.rowIndex,this.element.attributeStyleMap.set("transform",L.#a)}async slideDirectlyTo(t,n){const o=this.#o,i=this.#n,l=t.columnIndex,d=t.rowIndex;(o!=l||i!=d)&&(await this.element.animate([{transform:`translate(${o}px, ${i}px)`},{transform:`translate(${l}px, ${d}px)`}],n).finished,this.updateFinalPosition(t))}async rotateTo(t,n){const o=n=="horizontal",i=(()=>{const c=o?t.columnIndex-this.#o:t.rowIndex-this.#n,h=E.positiveModulo(c+y.SIZE/2,y.SIZE)-y.SIZE/2;return q(Math.abs(h))})(),{position:l,offset:d}=o?H(this.#o,t.columnIndex):H(this.#n,t.rowIndex),s=l.map(c=>o?`translate(${c}px, ${t.rowIndex}px)`:`translate(${t.columnIndex}px, ${c}px)`);this.updateFinalPosition(t),await this.element.animate({transform:s,offset:d},i).finished}#n=NaN;get rowIndex(){return this.#n}#o=NaN;get columnIndex(){return this.#o}constructor(t){const n=E.assertClass(L.#t.cloneNode(!0),SVGGElement);this.element=n,this.decorationElement=n.querySelector("text.crystal-decoration"),this.decorationBackgroundElement=n.querySelector("text.crystal-decoration-background"),this.#e=n.querySelector(".bomb"),this.#r=E.assertClass(n.querySelector("use[href='#explosionMaster']"),SVGUseElement),n.style.fill=t.color,this.decorationBackgroundElement.style.stroke=t.color,this.bombColor=E.pick(X.get(t.color)),this.bombVisible=t.bomb,this.explosionVisible=!1,this.updateFinalPosition(t),W.appendChild(n)}async remove(t=0){let n,o;n=Math.random()*(y.SIZE/2-1),o=Math.random()*(y.SIZE/2-1);{const i=Math.random()*3;i>1&&(n-=y.SIZE/2),i<2&&(o-=y.SIZE/2)}{const i=l=>Math.random()>(l+1)/(y.SIZE+1);i(this.#n)&&(n=y.SIZE-n-1),i(this.#o)&&(o=y.SIZE-o-1)}this.element.parentElement.appendChild(this.element),await this.slideDirectlyTo({rowIndex:n,columnIndex:o},{duration:1e3*x,easing:"ease-in",delay:t,fill:"backwards"}),this.element.remove(),this.element="💀"}get bombColor(){return this.#e.style.fill}set bombColor(t){this.#e.style.fill=t}removeDecoration(){[this.decorationElement,this.decorationBackgroundElement].forEach(t=>{t.textContent="",t.getAnimations().forEach(n=>n.cancel())}),this.explosionVisible=!1}}const U=e=>E.positiveModulo(e+.5,y.SIZE)-.5,H=(e,t)=>{const n=[e],o=[0];if(Math.abs(e-t)>y.SIZE/2){const i=(l,d)=>{n.push(l,d);const s=Math.abs(e-l),c=Math.abs(d-t),h=s+c,a=s/h;o.push(a,a)};t>e?i(-.5,y.SIZE-.5):i(y.SIZE-.5,-.5)}return n.push(t),o.push(1),{position:n,offset:o}},$=k("piece",HTMLTemplateElement).content.querySelector(".bomb"),Tt=k("main",SVGSVGElement);class xt{initializeBoard(t){W.innerHTML="",this.#t.clear(),t.forEach(n=>this.#t.set(n,new L(n)))}async updateBoard(t){this.#t.forEach((a,f)=>{a.bombVisible=f.bomb}),x=Math.pow(.75,t.counter-1)*.9+.1,t.flingBomb.length>1&&(x=Math.max(.5,Math.min(1,x*2)));const n=2e3*x;t.destroyByBomb.flat().forEach((a,f,w)=>{const p=this.#t.get(a);if(p===void 0)throw new Error("wtf");p.explosionVisible=!1,setTimeout(()=>{p.explosionVisible=!0},n/w.length*f)});const o=t.flingBomb.map(a=>a.map(({source:f,destination:w})=>{const p=this.#t.get(f);if(p===void 0)throw new Error("wtf");return{logicalSource:f,logicalDestination:w,guiSource:p}})),i=Promise.all(t.remove.map(a=>{const f=this.#t.get(a).remove(n);return this.#t.delete(a),f}));setTimeout(()=>this.#t.forEach(a=>a.removeDecoration()),n);const l=1e3*x;t.add.forEach(({initialRow:a,piece:f})=>{const w=new L(f);this.#t.set(f,w),w.updateFinalPosition({columnIndex:f.columnIndex,rowIndex:a})});let d=0;const s=[];this.#t.forEach((a,f)=>{const w=a.columnIndex,p=a.rowIndex,b=f.columnIndex,M=f.rowIndex,A=Math.hypot(M-p,b-w),T=q(A),I={duration:T,delay:n+l,fill:"backwards"};s.push(()=>a.slideDirectlyTo(f,I)),d=Math.max(d,T)});const c=Promise.all(o.flatMap(a=>{const f=n+l+d;return a.map((w,p)=>{const b=Math.min(n,f/2)/(a.length+1)*(p+1),M=f-b;return this.flingBomb(w,b,M)})})),h=Promise.all(s.map(a=>a()));await Promise.all([i,h,c])}async flingBomb(t,n,o){const{logicalSource:i,logicalDestination:l,guiSource:d}=t,s=this.#t.get(l),c=l.color,h=s.bombColor;d.bombColor=h,d.bombVisible=!0;const a=(()=>{const w=E.assertClass($.cloneNode(!0),SVGPathElement),p=E.assertClass($.cloneNode(!0),SVGPathElement);p.style.strokeWidth="75",w.style.fill=h,p.style.stroke=c;const b=document.createElementNS("http://www.w3.org/2000/svg","g");return b.appendChild(p),b.appendChild(w),b.style.offsetRotate="0deg",b})(),f=(()=>{const w={x:i.columnIndex,y:i.rowIndex},p={x:l.columnIndex,y:l.rowIndex};if(Math.random()<.3333333)return vt(w,p,.5+Math.random()*2+Math.random()*2);{const b=Math.random()*2*Math.PI,M=(Math.random()*2|0)*2-1,A=b+M*(.5+Math.random()*2)*2*Math.PI,T=.5+Math.random()*2,I=kt(w,p,St(T,b,A));return j(I,{numberOfSegments:20})}})();await E.sleep(n),d.bombVisible=!1,Tt.appendChild(a),a.style.offsetPath=`path('${f}')`,await a.animate({offsetDistance:["0%","100%"]},{duration:o,iterations:1,easing:"ease-in",fill:"both"}).finished,a.remove(),s.bombVisible=!0}#t=new Map;drawPreview(t,n,o){n.forEach(i=>{const l=this.#t.get(i);let{rowIndex:d,columnIndex:s}=i;t=="vertical"?d=U(d+o):s=U(s+o),l.updateFinalPosition({rowIndex:d,columnIndex:s})})}async rotateTo(t,n){const o=n.map(i=>this.#t.get(i).rotateTo(i,t));await Promise.all(o)}assignGroupDecorations(t){const n=()=>{this.#t.forEach(o=>o.removeDecoration())};if(t.groups.length==0)return{addToScore(){},highlightGroups(){n()}};{const o=[...V],i=t.groups.map(d=>{const s=d[0].color,c=E.pick(X.get(s)),h=E.take(o);return{guiPieces:d.map(f=>{const w=this.#t.get(f);if(w==null)throw new Error("wtf");return w}),decorationColor:c,decorationText:h,backgroundColor:s}}),l=t.explosions.map(d=>d.map(s=>{const c=this.#t.get(s);if(c==null)throw new Error("wtf");return c}));return{addToScore(d){i.forEach(({guiPieces:c})=>{const f=[{opacity:Math.random()*.2+.05},{opacity:1}],w={direction:E.pick(["alternate","alternate-reverse","normal","reverse"]),duration:(550+Math.random()*150)*x,easing:E.pick(["linear","ease-in","ease-out","ease-in-out"]),iterationStart:Math.random(),iterations:1/0};c.forEach(p=>{p.decorationElement.animate(f,w),p.decorationBackgroundElement.animate(f,w)})}),d<2?Z.innerHTML="":Z.innerText=`Chain Bonus: ⨉ ${d}`,P.innerHTML="",i.forEach(({guiPieces:c,decorationColor:h,decorationText:a,backgroundColor:f},w)=>{w>0&&P.append(" + ");const p=document.createElement("span");p.innerText=`${a} ${c.length}`,p.style.color=h,p.style.borderColor=p.style.backgroundColor=f,p.classList.add("individualScore"),P.appendChild(p)});const s=t.explosions.flat().length;if(s>0){i.length>0&&P.append(" + ");const c=document.createElementNS("http://www.w3.org/2000/svg","svg");c.setAttribute("viewBox","0.25 0.25 0.5 0.5");const h=$.cloneNode(!0);c.appendChild(h),c.style.width="1em",c.style.height="1em",c.style.fill="white";const a=document.createElement("span");a.innerHTML=`&nbsp;${s}`,a.style.color="white",a.style.borderColor=a.style.backgroundColor="black",a.classList.add("individualScore"),a.prepend(c),P.appendChild(a)}},highlightGroups(){n(),i.forEach(({guiPieces:d,decorationColor:s,decorationText:c})=>{d.forEach(h=>{const a=h.decorationElement;a.textContent=c,a.style.fill=s,h.decorationBackgroundElement.textContent=c})}),l.flat().forEach(d=>{d.explosionVisible=!0})}}}}}const At=new xt,Lt=k("decorationTester",HTMLDivElement);V.forEach(e=>{const t=document.createElement("div");t.innerText=`${e} u+${e.codePointAt(0).toString(16)}`,Lt.appendChild(t)});const Pt=""+new URL("cursor-2110db60.svg",import.meta.url).href;function Rt(e){const t=k("main",SVGSVGElement);function n(i){const l=t.getBoundingClientRect(),d=E.makeLinear(l.top,0,l.bottom,y.SIZE),s=E.makeLinear(l.left,0,l.right,y.SIZE);return{row:d(i.clientY),column:s(i.clientX)}}let o={state:"none"};t.addEventListener("pointerdown",i=>{if(o.state=="none"){i.stopPropagation(),t.setPointerCapture(i.pointerId);const l=n(i);t.style.cursor="move",o={state:"started",startRow:l.row,startColumn:l.column}}}),t.addEventListener("pointermove",i=>{if(o.state=="none"||o.state=="animation")return;i.stopPropagation();const l=n(i);if(o.state=="started"){const d=Math.abs(l.row-o.startRow),s=Math.abs(l.column-o.startColumn);if(Math.max(d,s)<.05)return;if(d>s){const c="vertical",h=Math.floor(o.startColumn),a=o.startRow,f=p=>{const{row:b}=n(p);return b-a},w=e.startVerticalMove(h);o={state:c,fixedIndex:h,startIndex:a,relevantMouseMove:f,actions:w},t.style.cursor="ns-resize"}else if(s>d){const c="horizontal",h=Math.floor(o.startRow),a=o.startColumn,f=p=>{const{column:b}=n(p);return b-a},w=e.startHorizontalMove(h);o={state:c,fixedIndex:h,startIndex:a,relevantMouseMove:f,actions:w},t.style.cursor="ew-resize"}else return}o.actions.preview(o.relevantMouseMove(i))}),t.addEventListener("lostpointercapture",async i=>{switch(o.state){case"started":break;case"horizontal":case"vertical":{t.style.cursor=`url("${Pt}"),none`;const l=o;o={state:"animation"},await l.actions.release(l.relevantMouseMove(i));break}default:throw new Error("wtf")}o={state:"none"},t.style.cursor="grab"})}{class e{constructor(){throw new Error("wtf")}static#t=0;static get next(){return`Unique_${this.#t++}`}}const t=(s,c,h)=>{const a=c=="checked",f=e.next,w=document.createElement("div");k("debugButtons",HTMLDivElement).appendChild(w);const p=document.createElement("input");p.type="checkbox",p.checked=a,p.id=f,w.appendChild(p);const b=document.createElement("label");b.innerText=s,b.htmlFor=f,w.appendChild(b),h(a),p.addEventListener("change",()=>h(p.checked))},n=[],o=k("background",SVGGElement),[i,l]=E.initializedArray(2,()=>{const s=document.createElementNS("http://www.w3.org/2000/svg","g");o.appendChild(s);const c=y.SIZE*(Math.SQRT2-1)/2,h=0-c,f=y.SIZE+c-h,w=()=>Math.random()*f+h,p=Math.ceil(f*1.2);for(let b=0;b<p;b++){const M=document.createElementNS("http://www.w3.org/2000/svg","circle");M.cx.baseVal.value=w(),M.cy.baseVal.value=w(),Math.random()>.6?(M.style.fill="none",M.style.stroke=E.pick(B),M.style.strokeWidth=`${.05+.2*Math.random()}px`,M.r.baseVal.value=(Math.random()/3+.15)*y.SIZE):(M.style.stroke="none",M.style.fill=E.pick(B),M.r.baseVal.value=Math.random()*.3+.1),s.appendChild(M)}return s});i.style.transformOrigin="2px 2px",l.style.transformOrigin="4px 4px",o.style.transformOrigin="3px 3px",n.push(i.animate([{transform:"rotate(0deg)"},{transform:"rotate(720deg)"}],{duration:67973,easing:"ease",iterations:1/0})),n.push(l.animate([{transform:"rotate(0deg)"},{transform:"rotate(360deg)"}],{duration:19701,easing:"cubic-bezier(0.42, 0, 0.32, 1.83)",iterations:1/0})),n.push(o.animate([{transform:"rotate(0deg)"},{transform:"rotate(720deg)"}],{duration:16797,easing:"ease-in-out",iterations:1/0,direction:"alternate"})),[[n,"line rotations","checked"]].forEach(([s,c,h])=>{t(`Animate ${c}`,h,a=>{const f=a?"play":"pause";s.forEach(w=>w[f]())})});const d=k("curtain",SVGRectElement);[[o,"background","checked"],[k("board",SVGGElement),"board","checked"],[d,"curtain","unchecked"]].forEach(([s,c,h])=>{t(`Show ${c}`,h,a=>{s.style.display=a?"":"none"})})}Rt(new y(At));
